<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Practice ¬∑ Premium (Final Estable)</title>

  <!-- CSS externos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Sora:wght@500;700;800&family=JetBrains+Mono:wght@400;600&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css">

  <style>
    :root{
      --bg0:#0a0f1e; --bg1:#0e162b; --muted:#788097;
      --ok:#16a34a; --bad:#ef4444; --brand1:#7c3aed; --brand2:#06b6d4;
      --mono:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --ui:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --title:"Sora","Inter",system-ui,sans-serif;
    }

    body{
      font-family:var(--ui);
      background:
        radial-gradient(1200px 900px at 10% 10%, rgba(124,58,237,.14), transparent 50%),
        radial-gradient(1000px 700px at 95% 20%, rgba(6,182,212,.12), transparent 50%),
        radial-gradient(1000px 700px at 20% 90%, rgba(34,197,94,.10), transparent 50%),
        linear-gradient(180deg, #f6f9fc, #eef2f7);
      min-height:100vh; color:#0f172a;
    }
    body.dark{
      background:
        radial-gradient(1200px 900px at 10% 10%, rgba(124,58,237,.22), transparent 50%),
        radial-gradient(1000px 700px at 95% 20%, rgba(6,182,212,.20), transparent 50%),
        radial-gradient(1000px 700px at 20% 90%, rgba(34,197,94,.16), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:#e5e7eb;
    }

    .title{font-family:var(--title);letter-spacing:-.02em;}
    .mono{font-family:var(--mono);}
    .hero{
      border-radius:28px; padding:22px;
      background:linear-gradient(120deg, rgba(124,58,237,.10), rgba(6,182,212,.10));
      border:1px solid rgba(124,58,237,.18);
      box-shadow:0 22px 60px rgba(15,23,42,.10); backdrop-filter:blur(10px);
    }
    body.dark .hero{ background:linear-gradient(120deg, rgba(124,58,237,.18), rgba(6,182,212,.16)); border-color:rgba(255,255,255,.10); }
    .app-card{
      border:0; border-radius:22px; box-shadow:0 18px 54px rgba(15,23,42,.12);
      background:rgba(255,255,255,.75); backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.45);
    }
    body.dark .app-card{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.10); }
    .soft{ background:linear-gradient(180deg, rgba(255,255,255,.64), rgba(255,255,255,.48)); border:1px solid rgba(15,23,42,.06); border-radius:16px; }
    body.dark .soft{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.10); }
    .tiny{font-size:.9rem;color:var(--muted);} body.dark .tiny{color:rgba(229,231,235,.75);}
    .nav-premium .nav-link{ border-radius:14px; padding:.7rem .9rem; font-weight:800; background:rgba(15,23,42,.04); border:1px solid rgba(15,23,42,.06); }
    body.dark .nav-premium .nav-link{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.10); color:#e5e7eb; }
    .nav-premium .nav-link.active{ background:linear-gradient(90deg, rgba(124,58,237,.90), rgba(6,182,212,.85)); color:#fff; box-shadow:0 14px 34px rgba(15,23,42,.18); border:0; }
    .btn-premium{ border-radius:16px; padding:.68rem 1rem; font-weight:700; }
    .btn-gradient{ color:#fff !important; background:linear-gradient(92deg, var(--brand1), var(--brand2)); border:0; }
    .list-compact .list-group-item{ border:0; border-radius:16px; margin-bottom:10px; background:rgba(15,23,42,.03); }
    body.dark .list-compact .list-group-item{ background:rgba(255,255,255,.06); }
    .seg{ display:inline-block; padding:.18rem .48rem; margin:.18rem .18rem 0 0; border-radius:999px; background:rgba(124,58,237,.10); border:1px solid rgba(124,58,237,.16); font-family:var(--mono); font-size:.86rem; }
    .word-ok{color:var(--ok);font-weight:900;} .word-bad{color:var(--bad);font-weight:900;}
    .kbd{ font-family:var(--mono); font-size:.82rem; padding:.12rem .38rem; border-radius:10px; border:1px solid rgba(148,163,184,.45); background:rgba(255,255,255,.85); }
    .load-more{ display:flex; justify-content:center; margin-top:8px; }
    .brand-badge{ width:44px;height:44px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, var(--brand1), var(--brand2));color:#fff; }
  </style>
</head>

<body>
<main class="container py-3">
  <!-- Hero -->
  <div class="hero mb-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-badge"><i class="fa-solid fa-sparkles"></i></div>
        <div>
          <div class="title fw-bold" style="font-size:1.6rem;">English Practice ¬∑ Premium</div>
          <div class="tiny">Podcasts + Frases online sin repetir + Pronunciaci√≥n ¬∑ 1 HTML</div>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="themeBtn" class="btn btn-light btn-premium" data-tippy-content="Tema claro/oscuro"><i class="fa-solid fa-moon"></i></button>
        <button id="helpBtn" class="btn btn-light btn-premium" data-tippy-content="Ayuda r√°pida"><i class="fa-regular fa-circle-question"></i></button>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Lateral -->
    <div class="col-lg-4">
      <div class="app-card p-3">
        <ul class="nav nav-pills nav-premium flex-column gap-2" id="tabs">
          <li class="nav-item"><button class="nav-link active" data-tab="podcasts"><i class="fa-solid fa-podcast me-2"></i>Podcasts</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="phrases"><i class="fa-solid fa-quote-left me-2"></i>Frases</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="practice"><i class="fa-solid fa-microphone-lines me-2"></i>Pronunciaci√≥n</button></li>
        </ul>

        <hr class="my-3">

        <div class="soft p-3">
          <div class="fw-semibold">Voz (TTS)</div>
          <div class="tiny">Usa SpeechSynthesis del navegador.</div>
          <select id="voiceSelect" class="form-select mt-2"></select>
        </div>

        <div class="soft p-3 mt-3">
          <div class="fw-semibold d-flex align-items-center justify-content-between">
            <span>Frase seleccionada</span>
            <span id="supportBadge" class="badge rounded-pill text-bg-warning">Mic‚Ä¶</span>
          </div>
          <div id="selectedPhrasePreview" class="tiny mt-1">Ninguna</div>
          <div class="d-grid mt-2">
            <button id="useSelectedBtn" class="btn btn-gradient btn-premium"><i class="fa-solid fa-arrow-right me-2"></i>Usar en Pronunciaci√≥n</button>
          </div>
        </div>

        <div class="soft p-3 mt-3">
          <div class="fw-semibold">Pronunciaci√≥n figurada</div>
          <div class="tiny">Ajusta la gu√≠a a tu preferencia.</div>
          <div class="row g-2 mt-2">
            <div class="col-6">
              <label class="tiny fw-semibold">TH</label>
              <select id="thMode" class="form-select form-select-sm">
                <option value="d" selected>TH ‚Üí ‚ÄúD‚Äù (MX)</option>
                <option value="z">TH ‚Üí ‚ÄúZ‚Äù (ES)</option>
              </select>
            </div>
            <div class="col-6">
              <label class="tiny fw-semibold">R</label>
              <select id="rMode" class="form-select form-select-sm">
                <option value="simple" selected>R simple</option>
                <option value="marked">R marcada (er/ar)</option>
              </select>
            </div>
          </div>
          <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" role="switch" id="stressMarks" checked>
            <label class="form-check-label tiny" for="stressMarks">Marcar acento (√°/√©/√≠/√≥/√∫)</label>
          </div>
        </div>

        <div class="tiny mt-3">
          <span class="kbd">Tip</span> Abre con doble clic; JSONP evita CORS. Si algo externo falla, reintenta.
        </div>
      </div>
    </div>

    <!-- Vistas -->
    <div class="col-lg-8">

      <!-- Podcasts -->
      <section id="view-podcasts" class="app-card p-3">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="title fw-bold fs-4"><i class="fa-solid fa-podcast me-2"></i>Podcasts</div>
            <div class="tiny">iTunes JSONP + rss2json JSONP. ‚ÄúVer m√°s‚Äù de 18 en 18.</div>
          </div>
          <div class="badge text-bg-primary">Premium UI</div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-md-8">
            <input id="podQuery" class="form-control form-control-lg" placeholder="Ej: english learning, science, business, news..." value="english learning" />
          </div>
          <div class="col-md-4 d-grid">
            <button id="podSearchBtn" class="btn btn-gradient btn-premium btn-lg"><i class="fa-solid fa-magnifying-glass me-2"></i>Buscar</button>
          </div>
        </div>

        <div id="podResults" class="mt-3"></div>
        <div class="load-more">
          <button id="morePodsBtn" class="btn btn-outline-primary btn-premium d-none"><i class="fa-solid fa-angles-down me-2"></i>Ver m√°s podcasts</button>
        </div>

        <div id="feedHeader" class="soft p-3 mt-3 d-none">
          <div class="d-flex gap-3 align-items-start">
            <img id="feedArt" src="" alt="" style="width:92px;height:92px;border-radius:18px;object-fit:cover;" loading="lazy">
            <div class="flex-grow-1">
              <div id="feedTitle" class="fw-bold"></div>
              <div id="feedDesc" class="tiny"></div>
            </div>
          </div>
        </div>

        <div id="episodes" class="mt-3 list-group list-compact"></div>
        <div class="load-more">
          <button id="moreEpsBtn" class="btn btn-outline-primary btn-premium d-none"><i class="fa-solid fa-angles-down me-2"></i>Ver m√°s episodios</button>
        </div>

        <div class="soft p-3 mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold"><i class="fa-solid fa-play me-2"></i>Reproductor</div>
            <div id="nowPlaying" class="tiny"></div>
          </div>
          <div class="mt-2">
            <audio id="player" controls class="w-100"></audio>
          </div>
        </div>
      </section>

      <!-- Frases -->
      <section id="view-phrases" class="app-card p-3 d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="title fw-bold fs-4"><i class="fa-solid fa-quote-left me-2"></i>Frases</div>
            <div class="tiny">Internet sin repetir (baraja con memoria entre sesiones).</div>
          </div>
          <div class="d-flex gap-2">
            <button id="getInternetPhraseBtn" class="btn btn-outline-primary btn-premium"><i class="fa-solid fa-cloud-arrow-down me-2"></i>Internet</button>
            <button id="clearCacheBtn" class="btn btn-outline-secondary btn-premium"><i class="fa-solid fa-broom me-2"></i>Cach√©</button>
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-md-8">
            <input id="newPhrase" class="form-control form-control-lg" placeholder="Escribe tu frase (corta o larga)..." />
          </div>
          <div class="col-md-4 d-grid">
            <button id="addPhraseBtn" class="btn btn-success btn-premium btn-lg"><i class="fa-solid fa-plus me-2"></i>Agregar</button>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-8">
            <input id="phraseSearch" class="form-control" placeholder="Buscar en tus frases..." />
          </div>
          <div class="col-md-4">
            <select id="tagFilter" class="form-select">
              <option value="">Todos los tags</option>
            </select>
          </div>
        </div>

        <div class="soft p-3 mt-3">
          <div class="fw-semibold"><i class="fa-solid fa-spell-check me-2"></i>Pronunciaci√≥n figurada (preview)</div>
          <div class="tiny">Selecciona una frase para ver gu√≠a y segmentos.</div>
          <div class="mt-2">
            <div class="tiny fw-semibold">Gu√≠a:</div>
            <div id="phoneticPreview" class="mono">‚Äî</div>
          </div>
          <div class="mt-2">
            <div class="tiny fw-semibold">Segmentos:</div>
            <div id="segmentsPreview">‚Äî</div>
          </div>
        </div>

        <div id="phrasesList" class="mt-3 list-group list-compact"></div>
      </section>

      <!-- Practice -->
      <section id="view-practice" class="app-card p-3 d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="title fw-bold fs-4"><i class="fa-solid fa-microphone-lines me-2"></i>Pronunciaci√≥n</div>
            <div class="tiny">SpeechRecognition (aproximado) + TTS.</div>
          </div>
          <span class="badge rounded-pill text-bg-warning">Aprox.</span>
        </div>

        <hr class="my-3">

        <label class="form-label fw-semibold">Frase objetivo</label>
        <textarea id="referenceText" class="form-control form-control-lg" rows="3" placeholder="Ej: I would like to improve my English pronunciation."></textarea>

        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <div class="soft p-3 h-100">
              <div class="fw-semibold"><i class="fa-solid fa-language me-2"></i>Gu√≠a al espa√±ol</div>
              <div class="tiny">Sonidos cercanos al espa√±ol.</div>
              <div class="mono mt-2" id="phoneticFromReference">‚Äî</div>
              <div class="mt-2">
                <div class="tiny fw-semibold">Segmentos:</div>
                <div id="segmentsFromReference">‚Äî</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="soft p-3 h-100">
              <div class="fw-semibold"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Acciones</div>
              <div class="d-flex flex-wrap gap-2 mt-2">
                <button id="ttsBtn" class="btn btn-secondary btn-premium"><i class="fa-solid fa-volume-high me-2"></i>Escuchar</button>
                <button id="startRecBtn" class="btn btn-gradient btn-premium"><i class="fa-solid fa-microphone me-2"></i>Probar</button>
                <button id="stopRecBtn" class="btn btn-outline-danger btn-premium d-none"><i class="fa-solid fa-stop me-2"></i>Detener</button>
              </div>
              <div class="tiny mt-2">Si no funciona el micr√≥fono, usa Chrome/Edge y permite permisos.</div>
            </div>
          </div>
        </div>

        <div class="row g-2 mt-3">
          <div class="col-md-4">
            <div class="soft p-3">
              <div class="tiny">Porcentaje</div>
              <div id="scorePct" class="title fw-bold" style="font-size:2.2rem;">‚Äî</div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="soft p-3">
              <div class="tiny">Lo que el navegador entendi√≥</div>
              <div id="recognizedText" class="mono mt-1">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="soft p-3 mt-3">
          <div class="tiny mb-2">Comparaci√≥n (verde = coincide, rojo = no coincide)</div>
          <div id="highlighted" class="lead mb-0">‚Äî</div>
        </div>
      </section>

    </div>
  </div>
</main>

<!-- JS externos -->
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const notyf = new Notyf({ duration: 2600, ripple: true, dismissible: true, position: { x:'right', y:'top' } });
  tippy('[data-tippy-content]', { animation: 'scale', theme: 'light-border' });

  const store = localforage.createInstance({ name: "english_practice_premium_final_stable_v1" });
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  const state = {
    // podcasts y episodios
    podsAll: [], podsShown: 0, podsPage: 18,
    epsAll: [], epsShown: 0, epsPage: 18,

    // frases
    phrases: [], selectedPhraseId: null, phraseFuse: null, tags: new Set(),

    // SR/TTS
    recognition: null, recognizing: false,

    // frases online (baraja)
    quotesDeck: [], deckIndex: 0, usedHashes: new Set()
  };

  const esc = (s="") => s.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

  /* --------------- Navegaci√≥n / Tema / Help --------------- */
  function showTab(tab){
    ["podcasts","phrases","practice"].forEach(t => $("view-"+t).classList.toggle("d-none", t !== tab));
    document.querySelectorAll("#tabs .nav-link").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tab));
  }
  $("tabs").addEventListener("click", (e) => { const btn = e.target.closest("button[data-tab]"); if (!btn) return; showTab(btn.dataset.tab); });

  async function applyTheme(isDark){
    document.body.classList.toggle("dark", isDark);
    $("themeBtn").querySelector("i").className = isDark ? "fa-solid fa-sun" : "fa-solid fa-moon";
    await store.setItem("theme_dark", isDark);
  }
  $("themeBtn").addEventListener("click", async () => { await applyTheme(!document.body.classList.contains("dark")); });
  $("helpBtn").addEventListener("click", () => {
    notyf.open({ type: "info", message: "Podcasts y episodios por JSONP (sin CORS). Usa 'Ver m√°s' para cargar 18 adicionales." });
  });

  /* --------------- Speech support --------------- */
  function setupSpeechSupport(){
    const ok = !!SR;
    $("supportBadge").className = "badge rounded-pill " + (ok ? "text-bg-success" : "text-bg-danger");
    $("supportBadge").textContent = ok ? "Mic OK" : "Sin SR";
  }

  /* --------------- TTS --------------- */
  function loadVoices(){
    const sel = $("voiceSelect");
    const voices = speechSynthesis.getVoices();
    sel.innerHTML = "";
    let list = voices.filter(v => (v.lang || "").toLowerCase().startsWith("en"));
    if (!list.length) list = voices;
    list.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
      sel.appendChild(opt);
    });
    store.getItem("tts_voice").then(name => { if (name && list.some(v => v.name === name)) sel.value = name; });
    sel.onchange = () => store.setItem("tts_voice", sel.value);
  }
  speechSynthesis.onvoiceschanged = loadVoices;
  setTimeout(loadVoices, 300);

  function speak(text){
    if (!text) return notyf.error("No hay texto para leer.");
    const ready = () => new Promise(r=>{
      if (speechSynthesis.getVoices().length) return r();
      const t = setInterval(()=>{ if (speechSynthesis.getVoices().length){ clearInterval(t); r(); } }, 120);
      setTimeout(()=>{ clearInterval(t); r(); }, 1800);
    });
    ready().then(()=>{
      const u = new SpeechSynthesisUtterance(text);
      const voices = speechSynthesis.getVoices();
      const chosen = voices.find(v => v.name === $("voiceSelect").value) || voices.find(v => (v.lang||"").toLowerCase().startsWith("en")) || voices[0];
      if (chosen) u.voice = chosen;
      u.rate = 1.0; u.pitch = 1.0;
      try { speechSynthesis.cancel(); } catch {}
      speechSynthesis.speak(u);
    });
  }
  $("ttsBtn").addEventListener("click", () => speak($("referenceText").value.trim()));

  /* --------------- JSONP helper --------------- */
  function jsonp(url, { timeout=18000, callbackParam="callback" } = {}) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const full = `${url}${url.includes("?") ? "&" : "?"}${callbackParam}=${cbName}`;
      const script = document.createElement("script"); let done=false;
      window[cbName] = (data) => { done=true; cleanup(); resolve(data); };
      const timer = setTimeout(()=>{ if(done) return; done=true; cleanup(); reject(new Error("JSONP timeout")); }, timeout);
      function cleanup(){ clearTimeout(timer); delete window[cbName]; script.remove(); }
      script.onerror = () => { if(done) return; done=true; cleanup(); reject(new Error("JSONP error")); };
      script.src = full; document.head.appendChild(script);
    });
  }

  /* --------------- Podcasts (iTunes JSONP) + ‚ÄúVer m√°s‚Äù --------------- */
  async function searchPodcasts(term){
    const q = encodeURIComponent(term.trim());
    const url = `https://itunes.apple.com/search?term=${q}&media=podcast&entity=podcast&limit=200`;
    const data = await jsonp(url, { callbackParam: "callback" });
    const raw = (data && data.results) ? data.results : [];
    const list = raw.filter(x => x.feedUrl).map(p => ({
      title: p.collectionName || p.trackName || "Podcast",
      author: p.artistName || "",
      artwork: p.artworkUrl100 || p.artworkUrl60 || "",
      feedUrl: p.feedUrl || ""
    }));
    // deduplicar feedUrl
    const seen = new Set(); const uniq = [];
    for (const it of list){
      const k = (it.feedUrl||"").trim().toLowerCase();
      if (!k || seen.has(k)) continue;
      seen.add(k); uniq.push(it);
    }
    return uniq;
  }

  function renderPodcastsSlice(){
    const box = $("podResults");
    if (!state.podsAll.length){
      box.innerHTML = `<div class="soft p-3 tiny">Sin resultados. Prueba: <span class="kbd">english learning</span> o <span class="kbd">news</span>.</div>`;
      $("morePodsBtn").classList.add("d-none");
      return;
    }
    const slice = state.podsAll.slice(0, state.podsShown);
    box.innerHTML = `
      <div class="tiny mb-2">Selecciona un podcast para cargar episodios:</div>
      <div class="list-group list-compact">
        ${slice.map(p => `
          <button class="list-group-item text-start" data-feed="${esc(p.feedUrl)}">
            <div class="d-flex gap-3 align-items-start">
              <img src="${esc(p.artwork)}" alt="" style="width:64px;height:64px;border-radius:14px;object-fit:cover;" loading="lazy" onerror="this.src='';">
              <div class="flex-grow-1">
                <div class="fw-bold">${esc(p.title)}</div>
                <div class="tiny">${esc(p.author || "")}</div>
                <div class="tiny mono">${esc(p.feedUrl)}</div>
              </div>
              <span class="badge text-bg-primary align-self-center">Abrir</span>
            </div>
          </button>
        `).join("")}
      </div>
    `;
    box.querySelectorAll("button[data-feed]").forEach(btn => btn.onclick = () => loadEpisodes(btn.dataset.feed));
    $("morePodsBtn").classList.toggle("d-none", state.podsShown >= state.podsAll.length);
  }

  $("podSearchBtn").addEventListener("click", async () => {
    const term = $("podQuery").value.trim();
    if (!term) return notyf.error("Escribe algo para buscar.");

    $("podSearchBtn").disabled = true;
    $("podSearchBtn").innerHTML = `<i class="fa-solid fa-spinner fa-spin me-2"></i>Buscando‚Ä¶`;

    $("podResults").innerHTML = "";
    $("episodes").innerHTML = "";
    $("feedHeader").classList.add("d-none");
    $("moreEpsBtn").classList.add("d-none");

    try{
      const list = await searchPodcasts(term);
      state.podsAll = list;
      state.podsShown = Math.min(state.podsPage, list.length);
      renderPodcastsSlice();
      notyf.success(`Resultados: ${list.length}`);
    } catch (e) {
      console.warn(e);
      notyf.error("No se pudo buscar ahora.");
      $("podResults").innerHTML = `<div class="soft p-3 tiny">Error temporal al buscar.</div>`;
    } finally {
      $("podSearchBtn").disabled = false;
      $("podSearchBtn").innerHTML = `<i class="fa-solid fa-magnifying-glass me-2"></i>Buscar`;
    }
  });

  $("morePodsBtn").addEventListener("click", () => {
    state.podsShown = Math.min(state.podsShown + state.podsPage, state.podsAll.length);
    renderPodcastsSlice();
  });

  /* --------------- Episodios (rss2json JSONP) + ‚ÄúVer m√°s‚Äù --------------- */
  async function loadEpisodes(feedUrl){
    if (!feedUrl) return notyf.error("Este podcast no tiene RSS (feedUrl).");

    $("episodes").innerHTML = `<div class="soft p-3 tiny"><i class="fa-solid fa-spinner fa-spin me-2"></i>Cargando episodios‚Ä¶</div>`;
    $("feedHeader").classList.add("d-none");
    $("moreEpsBtn").classList.add("d-none");
    state.epsAll = []; state.epsShown = 0;

    try{
      // Pedimos el m√°ximo que permite rss2json en una sola llamada (count=100)
      const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}&count=100`;
      const data = await jsonp(api, { callbackParam: "callback", timeout: 20000 });
      if (data.status !== "ok") throw new Error(data.message || "rss2json error");

      const feed = data.feed || {};
      const items = Array.isArray(data.items) ? data.items : [];

      $("feedArt").src = feed.image || "";
      $("feedTitle").textContent = feed.title || "Podcast";
      $("feedDesc").textContent = (feed.description || "").replace(/<[^>]+>/g,"").trim().slice(0, 220);
      $("feedHeader").classList.remove("d-none");

      const eps = items.map(it => {
        const title = it.title || "(sin t√≠tulo)";
        const desc = (it.description || "").replace(/<[^>]+>/g,"").trim();
        const pubDate = it.pubDate || it.pubDate_raw || "";
        const audioUrl = it.enclosure?.link || it.enclosure?.url || "";
        return { title, desc, pubDate, audioUrl };
      }).filter(x => x.audioUrl);

      if (!eps.length){
        $("episodes").innerHTML = `<div class="soft p-3 tiny">No encontr√© episodios reproducibles.</div>`;
        return;
      }

      state.epsAll = eps;
      state.epsShown = Math.min(state.epsPage, eps.length);
      renderEpisodesSlice();
      notyf.success("Episodios cargados.");
    } catch (e) {
      console.warn(e);
      notyf.error("No se pudo cargar el RSS (rss2json).");
      $("episodes").innerHTML = `<div class="soft p-3 tiny">Error cargando episodios. Prueba con otro podcast.</div>`;
    }
  }

  function renderEpisodesSlice(){
    const box = $("episodes");
    if (!state.epsAll.length){
      box.innerHTML = `<div class="soft p-3 tiny">No hay episodios para mostrar.</div>`;
      $("moreEpsBtn").classList.add("d-none");
      return;
    }
    const slice = state.epsAll.slice(0, state.epsShown);
    box.innerHTML = slice.map(ep => `
      <button class="list-group-item text-start" data-audio="${esc(ep.audioUrl)}" data-title="${esc(ep.title)}">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-bold">${esc(ep.title)}</div>
            <div class="tiny">${esc(ep.pubDate ? dayjs(ep.pubDate).format("DD MMM YYYY") : "")}</div>
            <div class="tiny truncate-2">${esc(ep.desc)}</div>
          </div>
          <span class="badge rounded-pill text-bg-primary">Play</span>
        </div>
      </button>
    `).join("");

    box.querySelectorAll("button[data-audio]").forEach(btn => {
      btn.onclick = () => {
        const url = btn.dataset.audio;
        const title = btn.dataset.title || "";
        $("nowPlaying").textContent = title;
        const audio = $("player");
        audio.src = url;
        audio.play().catch(()=>{});
      };
    });

    $("moreEpsBtn").classList.toggle("d-none", state.epsShown >= state.epsAll.length);
  }

  $("moreEpsBtn").addEventListener("click", () => {
    state.epsShown = Math.min(state.epsShown + state.epsPage, state.epsAll.length);
    renderEpisodesSlice();
  });

  /* --------------- Frases online sin repetir --------------- */
  const FALLBACK_DECK = [
    "Small progress is still progress. ‚Äî Unknown",
    "The secret of getting ahead is getting started. ‚Äî Mark Twain",
    "If you want to go fast, go alone. If you want to go far, go together. ‚Äî African Proverb",
    "Success is the sum of small efforts, repeated day in and day out. ‚Äî Robert Collier",
    "What we think, we become. ‚Äî Buddha",
    "Well done is better than well said. ‚Äî Benjamin Franklin",
    "It always seems impossible until it‚Äôs done. ‚Äî Nelson Mandela",
    "Action is the foundational key to all success. ‚Äî Pablo Picasso",
    "Quality is not an act, it is a habit. ‚Äî Aristotle",
    "Dream big and dare to fail. ‚Äî Norman Vaughan",
    "Either you run the day or the day runs you. ‚Äî Jim Rohn",
    "Don‚Äôt watch the clock; do what it does. Keep going. ‚Äî Sam Levenson",
    "Start where you are. Use what you have. Do what you can. ‚Äî Arthur Ashe",
    "Dreams don‚Äôt work unless you do. ‚Äî John C. Maxwell",
    "The only way to do great work is to love what you do. ‚Äî Steve Jobs",
    "Focus on being productive instead of busy. ‚Äî Tim Ferriss",
    "If you get tired, learn to rest, not to quit. ‚Äî Banksy",
    "Discipline is destiny. ‚Äî Ryan Holiday",
    "You are what you do, not what you say you‚Äôll do. ‚Äî Carl Jung",
    "A little progress each day adds up to big results. ‚Äî Unknown",
    "Courage is grace under pressure. ‚Äî Ernest Hemingway",
    "Win the morning, win the day. ‚Äî Tim Ferriss",
    "Your limitation‚Äîit‚Äôs only your imagination. ‚Äî Unknown",
    "Do the hard things. ‚Äî Unknown"
  ];
  const sha1Like = s => { let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i)|0;} return String(h); };
  const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };

  async function loadDeckFromStore(){
    state.quotesDeck = (await store.getItem("quotes_deck")) || [];
    state.deckIndex = (await store.getItem("quotes_deck_index")) || 0;
    state.usedHashes = new Set((await store.getItem("quotes_used_hashes")) || []);
  }
  async function saveDeck(){
    await store.setItem("quotes_deck", state.quotesDeck);
    await store.setItem("quotes_deck_index", state.deckIndex);
    await store.setItem("quotes_used_hashes", Array.from(state.usedHashes));
  }

  async function providerQuotable(){
    const r = await fetch("https://api.quotable.io/quotes/random?limit=60&tags=famous-quotes|wisdom|inspirational", { cache:"no-store" });
    if (!r.ok) throw new Error("Quotable");
    const arr = await r.json();
    return (Array.isArray(arr)?arr:[]).map(x=>({ text:(x.content||"").trim(), author:(x.author||"").trim() }))
      .filter(x => x.text.length >= 10 && x.text.length <= 200);
  }
  async function providerTypeFit(){
    const r = await fetch("https://type.fit/api/quotes", { cache:"no-store" });
    if (!r.ok) throw new Error("type.fit");
    const arr = await r.json();
    return (Array.isArray(arr)?arr:[]).slice(0,600).map(x=>({ text:(x.text||"").trim(), author:(x.author||"").trim() }))
      .filter(x => x.text.length >= 10 && x.text.length <= 200);
  }

  async function buildNewDeck(){
    let combined = [];
    try{
      const [a,b] = await Promise.allSettled([providerQuotable(), providerTypeFit()]);
      if (a.status==="fulfilled") combined = combined.concat(a.value);
      if (b.status==="fulfilled") combined = combined.concat(b.value);
    }catch{}
    if (!combined.length){
      combined = FALLBACK_DECK.map(t=>{ const [text,author=""] = t.split(" ‚Äî "); return { text, author }; });
    }
    const seen = new Set(); const cleaned = [];
    for (const q of combined){
      const key = q.text.trim().toLowerCase(); if (seen.has(key)) continue; seen.add(key);
      const h = sha1Like(key); if (state.usedHashes.has(h)) continue;
      cleaned.push(q);
    }
    shuffle(cleaned);
    state.quotesDeck = cleaned; state.deckIndex = 0;
    await saveDeck();
  }

  async function getNextQuote(){
    if (!state.quotesDeck.length || state.deckIndex >= state.quotesDeck.length){
      await buildNewDeck();
      if (!state.quotesDeck.length){ state.usedHashes = new Set(); await buildNewDeck(); }
    }
    const q = state.quotesDeck[state.deckIndex++]; if (!q) return null;
    state.usedHashes.add(sha1Like(q.text.trim().toLowerCase()));
    await saveDeck();
    return q;
  }

  $("getInternetPhraseBtn").addEventListener("click", async () => {
    try{
      $("getInternetPhraseBtn").disabled = true;
      $("getInternetPhraseBtn").innerHTML = `<i class="fa-solid fa-spinner fa-spin me-2"></i>Cargando‚Ä¶`;
      const q = await getNextQuote();
      if (!q) throw new Error("Sin frases disponibles");
      const text = q.author ? `${q.text} ‚Äî ${q.author}` : q.text;
      state.phrases.unshift({ id: crypto.randomUUID(), text, createdAt: Date.now(), tags:["internet"], source:"internet" });
      await savePhrases(); rebuildTags(); buildFuse(); renderTagFilter(); renderPhrases(); renderSelectedPreview();
      notyf.success("Frase agregada.");
    } catch(e){ notyf.error("Error al traer frase."); }
    finally{
      $("getInternetPhraseBtn").disabled = false;
      $("getInternetPhraseBtn").innerHTML = `<i class="fa-solid fa-cloud-arrow-down me-2"></i>Internet`;
    }
  });

  $("clearCacheBtn").addEventListener("click", async () => {
    await store.removeItem("quotes_deck"); await store.removeItem("quotes_deck_index"); await store.removeItem("quotes_used_hashes");
    state.quotesDeck=[]; state.deckIndex=0; state.usedHashes=new Set();
    notyf.success("Cach√© de frases limpiada.");
  });

  /* --------------- Phrases CRUD --------------- */
  function rebuildTags(){
    state.tags = new Set();
    state.phrases.forEach(p => (p.tags || []).forEach(t => state.tags.add(t)));
  }
  function buildFuse(){
    state.phraseFuse = new Fuse(state.phrases, { keys:["text","tags","source"], threshold:0.35, ignoreLocation:true, includeScore:true });
  }
  function renderTagFilter(){
    const sel = $("tagFilter"); const prev = sel.value;
    sel.innerHTML = `<option value="">Todos los tags</option>` + Array.from(state.tags).sort().map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join("");
    sel.value = prev || "";
  }
  async function loadPhrases(){
    state.phrases = (await store.getItem("phrases")) || [];
    state.selectedPhraseId = (await store.getItem("selectedPhraseId")) || null;
    if (!state.phrases.length){
      state.phrases = [
        { id: crypto.randomUUID(), text:"I would like to improve my English pronunciation.", createdAt: Date.now(), tags:["starter"], source:"starter" },
        { id: crypto.randomUUID(), text:"Could you please repeat that more slowly?", createdAt: Date.now(), tags:["starter"], source:"starter" },
        { id: crypto.randomUUID(), text:"What do you recommend I practice today?", createdAt: Date.now(), tags:["daily"], source:"starter" },
      ];
      await store.setItem("phrases", state.phrases);
    }
    rebuildTags(); buildFuse(); renderTagFilter(); renderPhrases(); renderSelectedPreview();
  }
  async function savePhrases(){ await store.setItem("phrases", state.phrases); }
  function getSelected(){ return state.phrases.find(x => x.id === state.selectedPhraseId) || null; }

  function renderSelectedPreview(){
    const p = getSelected();
    $("selectedPhrasePreview").textContent = p ? p.text : "Ninguna";
    const ph = p ? englishToSpanishPhonetic(p.text) : "‚Äî";
    $("phoneticPreview").textContent = ph;
    $("segmentsPreview").innerHTML = makeSegments(ph);
  }

  function renderPhrases(){
    const box = $("phrasesList");
    const q = $("phraseSearch").value.trim();
    const tag = $("tagFilter").value || "";
    let list = state.phrases.slice();
    if (q && state.phraseFuse) list = state.phraseFuse.search(q).map(r=>r.item);
    if (tag) list = list.filter(p => (p.tags||[]).includes(tag));
    if (!list.length){ box.innerHTML = `<div class="soft p-3 tiny">No hay coincidencias.</div>`; return; }

    box.innerHTML = list.map(p => {
      const isSel = p.id === state.selectedPhraseId;
      const tags = (p.tags||[]).map(t=>`<span class="badge rounded-pill text-bg-secondary me-1">${esc(t)}</span>`).join("") || `<span class="tiny">sin tags</span>`;
      const phon = englishToSpanishPhonetic(p.text);
      return `
        <div class="list-group-item">
          <div class="d-flex justify-content-between gap-2">
            <div class="flex-grow-1">
              <div class="fw-bold ${isSel ? 'text-success' : ''}">${esc(p.text)}</div>
              <div class="tiny mt-1">${tags}</div>
              <div class="tiny">${dayjs(p.createdAt).format("DD MMM YYYY ‚Ä¢ HH:mm")} ¬∑ <span class="kbd">${esc(p.source||"custom")}</span></div>
              <div class="soft p-2 mt-2">
                <div class="tiny fw-semibold">Pronunciaci√≥n figurada:</div>
                <div class="mono">${esc(phon)}</div>
                <div class="mt-1">${makeSegments(phon)}</div>
              </div>
            </div>
            <div class="btn-group btn-group-sm align-self-start">
              <button class="btn ${isSel?'btn-success':'btn-outline-success'}" data-act="select" data-id="${p.id}">${isSel?'OK':'Seleccionar'}</button>
              <button class="btn btn-outline-secondary" data-act="speak" data-id="${p.id}"><i class="fa-solid fa-volume-high"></i></button>
              <button class="btn btn-outline-primary" data-act="tag" data-id="${p.id}"><i class="fa-solid fa-tags"></i></button>
              <button class="btn btn-outline-danger" data-act="del" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    box.querySelectorAll("button[data-act]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id; const act = btn.dataset.act; const item = state.phrases.find(x=>x.id===id);
        if (!id) return;
        if (act==="select"){
          state.selectedPhraseId = id; await store.setItem("selectedPhraseId", id);
          renderPhrases(); renderSelectedPreview(); notyf.success("Frase seleccionada.");
        }
        if (act==="speak" && item){ speak(item.text); }
        if (act==="del"){
          state.phrases = state.phrases.filter(x=>x.id!==id);
          if (state.selectedPhraseId===id){ state.selectedPhraseId=null; await store.removeItem("selectedPhraseId"); }
          await savePhrases(); rebuildTags(); buildFuse(); renderTagFilter(); renderPhrases(); renderSelectedPreview(); notyf.success("Eliminada.");
        }
        if (act==="tag" && item){
          const t = prompt("Tags (separados por coma). Ej: daily, travel, work", (item.tags||[]).join(", "));
          if (t===null) return;
          const tags = t.split(",").map(x=>x.trim().toLowerCase()).filter(Boolean).slice(0,8);
          item.tags = Array.from(new Set(tags));
          await savePhrases(); rebuildTags(); buildFuse(); renderTagFilter(); renderPhrases(); renderSelectedPreview(); notyf.success("Tags actualizados.");
        }
      };
    });
  }

  $("addPhraseBtn").onclick = async () => {
    const t = $("newPhrase").value.trim();
    if (!t) return notyf.error("Escribe una frase.");
    state.phrases.unshift({ id: crypto.randomUUID(), text: t, createdAt: Date.now(), tags:["custom"], source:"custom" });
    $("newPhrase").value = ""; await savePhrases();
    rebuildTags(); buildFuse(); renderTagFilter(); renderPhrases(); notyf.success("Frase agregada.");
  };
  $("phraseSearch").oninput = renderPhrases;
  $("tagFilter").onchange = renderPhrases;
  $("useSelectedBtn").onclick = () => {
    const p = getSelected(); if (!p) return notyf.error("Primero selecciona una frase.");
    $("referenceText").value = p.text; updatePhoneticFromReference(); showTab("practice"); notyf.success("Frase enviada.");
  };
  $("podQuery").addEventListener("keydown", e=>{ if(e.key==="Enter") $("podSearchBtn").click(); });
  $("newPhrase").addEventListener("keydown", e=>{ if(e.key==="Enter") $("addPhraseBtn").click(); });

  /* --------------- SR --------------- */
  function normalizeWords(text){
    return text.toLowerCase().replace(/[^a-z0-9\s']/g," ").replace(/\s+/g," ").trim().split(" ").filter(Boolean);
  }
  function levenshtein(a,b){ const n=a.length,m=b.length; if(!n) return m; if(!m) return n; const dp=Array.from({length:n+1},()=>Array(m+1).fill(0)); for(let i=0;i<=n;i++) dp[i][0]=i; for(let j=0;j<=m;j++) dp[0][j]=j; for(let i=1;i<=n;i++){ for(let j=1;j<=m;j++){ const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);} } return dp[n][m]; }
  function similarityPct(ref,said){ const a=ref.trim().toLowerCase(), b=said.trim().toLowerCase(); if(!a&&!b) return 100; if(!a||!b) return 0; const d=levenshtein(a,b), L=Math.max(a.length,b.length); return Math.max(0,Math.min(100,Math.round((1-d/L)*100))); }
  function highlightByWords(reference,recognized){
    const ref=normalizeWords(reference), rec=normalizeWords(recognized); let ptr=0, out=[];
    for(const w of ref){ let found=false; for(let k=ptr;k<rec.length;k++){ if(rec[k]===w){ found=true; ptr=k+1; break; } } out.push(found?`<span class="word-ok">${esc(w)}</span>`:`<span class="word-bad">${esc(w)}</span>`); }
    return out.join(" ");
  }

  function startRecognition(){
    if(!SR) return notyf.error("Tu navegador no soporta SpeechRecognition.");
    const reference=$("referenceText").value.trim(); if(!reference) return notyf.error("Escribe una frase objetivo.");
    const rec=new SR(); rec.lang="en-US"; rec.interimResults=true; rec.continuous=false;
    state.recognition=rec; state.recognizing=true;
    $("startRecBtn").classList.add("d-none"); $("stopRecBtn").classList.remove("d-none");
    $("recognizedText").textContent="Escuchando‚Ä¶"; $("highlighted").textContent="‚Äî"; $("scorePct").textContent="‚Äî";
    let finalText="";

    rec.onresult=(event)=>{
      let interim=""; for(let i=event.resultIndex;i<event.results.length;i++){ const t=event.results[i][0].transcript; if(event.results[i].isFinal) finalText+=t+" "; else interim+=t; }
      const shown=(finalText+interim).trim();
      $("recognizedText").textContent=shown||"‚Ä¶";
      $("scorePct").textContent=similarityPct(reference,shown)+"%";
      $("highlighted").innerHTML=highlightByWords(reference,shown);
    };
    rec.onerror=(e)=>{ stopRecognition(); notyf.error("Error de mic/reconocimiento."); };
    rec.onend=()=>{ if(!state.recognizing) return; stopRecognition(); notyf.success("Evaluaci√≥n terminada."); };
    rec.start(); notyf.open({ type:"info", message:"üéôÔ∏è Habla la frase completa." });
  }
  function stopRecognition(){
    if(state.recognition){ try{ state.recognition.stop(); }catch{} }
    state.recognition=null; state.recognizing=false;
    $("startRecBtn").classList.remove("d-none"); $("stopRecBtn").classList.add("d-none");
  }
  $("startRecBtn").onclick = startRecognition;
  $("stopRecBtn").onclick = stopRecognition;

  /* --------------- Pronunciaci√≥n figurada --------------- */
  function cfg(){ return { th:$("thMode").value, r:$("rMode").value, stress:$("stressMarks").checked }; }
  async function saveCfg(){ await store.setItem("phonetic_cfg", cfg()); }
  ["thMode","rMode","stressMarks"].forEach(id => $(id).addEventListener("change", async ()=>{ await saveCfg(); renderPhrases(); renderSelectedPreview(); updatePhoneticFromReference(); }));

  function englishToSpanishPhonetic(text){
    const words=(text||"").replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'").split(/\s+/).filter(Boolean);
    return words.map(w=>wordToPhonetic(w,cfg())).join(" ");
  }
  function wordToPhonetic(word,opt){
    const m=word.match(/^(.+?)([.,!?;:]*)$/); let core=m?m[1]:word; const punct=m?m[2]:""; const lower=core.toLowerCase();
    const dict={ "the":opt.th==="z"?"ze":"de","this":opt.th==="z"?"zis":"dis","that":opt.th==="z"?"zat":"dat","these":opt.th==="z"?"ziiz":"diiz","those":opt.th==="z"?"z√≥uz":"d√≥uz",
      "you":"yuu","your":"yor","are":"ar","to":"t√∫","of":"ov","for":"for","and":"and","with":"w√≠d","what":"w√°t","when":"wen","where":"wer","why":"w√°i","how":"j√°u",
      "i":"√°i","my":"m√°i","we":"w√≠","they":opt.th==="z"?"z√©i":"dei","it":"it","is":"iz","was":"wos","were":"wer","please":"pl√≠iz","english":"√≠nglish","pronunciation":"pron√°nsi√©ishon","repeat":"rip√≠it","slowly":"sl√≥uli","today":"tud√©i" };
    if(dict[lower]) return dict[lower]+punct;
    let x=lower;
    x=x.replace(/n't\b/g,"nt").replace(/'re\b/g," ar").replace(/'ll\b/g,"l").replace(/'ve\b/g,"v").replace(/'d\b/g,"d").replace(/'m\b/g,"m");
    x=x.replace(/ing\b/g,"in").replace(/tion\b/g,"shon").replace(/sion\b/g,"shon");
    x=x.replace(/ph/g,"f").replace(/ght/g,"t").replace(/kn/g,"n").replace(/wr/g,"r").replace(/wh/g,"w").replace(/qu/g,"kw");
    x=x.replace(/ch/g,"ch").replace(/sh/g,"sh");
    x=x.replace(/th/g, opt.th==="z" ? "z" : "d");
    x=x.replace(/ee/g,"ii").replace(/ea/g,"ii").replace(/oo/g,"uu");
    x=x.replace(/ou/g,"au").replace(/ow/g,"au").replace(/ai/g,"ei").replace(/ay/g,"ei").replace(/igh/g,"ai").replace(/ie/g,"ai").replace(/oa/g,"√≥u");
    x=x.replace(/ce/g,"s").replace(/ci/g,"si").replace(/cy/g,"si");
    x=x.replace(/ge/g,"y").replace(/gi/g,"yi").replace(/gy/g,"yi");
    x=x.replace(/ck/g,"k").replace(/c/g,"k");
    x=x.replace(/j/g,"y");
    x=x.replace(/y\b/g,"i");
    x=x.replace(/e\b/g,"");
    if(opt.r==="marked"){ x=x.replace(/er\b/g,"er").replace(/ar\b/g,"ar").replace(/or\b/g,"or"); }
    x=x.replace(/(.)\1+/g,"$1$1");
    if(opt.stress) x=addStressMark(x);
    if(/^[A-Z√Å√â√ç√ì√ö√ë]/.test(core)) x=x.charAt(0).toUpperCase()+x.slice(1);
    return x+punct;
  }
  function addStressMark(w){
    const vowels="aeiou"; const pos=[]; for(let i=0;i<w.length;i++) if(vowels.includes(w[i])) pos.push(i);
    if(pos.length<=1) return w; const idx=pos[Math.max(0,pos.length-2)];
    const map={a:"√°",e:"√©",i:"√≠",o:"√≥",u:"√∫"}; const ch=w[idx]; return map[ch] ? (w.slice(0,idx)+map[ch]+w.slice(idx+1)) : w;
  }
  function makeSegments(phon){
    if(!phon||phon==="‚Äî") return "‚Äî"; return phon.split(/\s+/).filter(Boolean).slice(0,24).map(t=>`<span class="seg">${esc(t)}</span>`).join("") || "‚Äî";
  }
  function updatePhoneticFromReference(){
    const t=$("referenceText").value.trim(); const ph=t ? englishToSpanishPhonetic(t) : "‚Äî";
    $("phoneticFromReference").textContent=ph; $("segmentsFromReference").innerHTML=makeSegments(ph);
  }
  $("referenceText").addEventListener("input", updatePhoneticFromReference);

  /* --------------- Init --------------- */
  async function init(){
    const dark = !!(await store.getItem("theme_dark"));
    document.body.classList.toggle("dark", dark);
    $("themeBtn").querySelector("i").className = dark ? "fa-solid fa-sun" : "fa-solid fa-moon";

    setupSpeechSupport();
    await loadPhrases();
    await loadDeckFromStore();

    renderPhrases(); renderSelectedPreview(); showTab("podcasts"); updatePhoneticFromReference();
    $("podSearchBtn").click(); // b√∫squeda inicial
    notyf.success("Listo ‚úÖ");
  }
  init();
})();
</script>
</body>
</html>
